<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/admin/manage user/manageUser.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <title>Add User</title>
  </head>
  <body>
    <!--Side bar-->
    <div class="sidebar">
        <!--logo on sidebar-->
        <img src="/images/ki_logo.png" alt="Logo" class="logo">
        <!--Dashboard button-->
        <ul class="menu-item ">
            <li class="active">
                <a href="/admin/adminDashboard.html">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
        </ul>
        <!--Educators button-->
        <ul class="menu-item ">
            <li>
                <a href="/admin/educator/educators.html">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Educators</span>
                </a>
            </li>
        </ul>
        <!--SEL Themes button-->
        <ul class="menu-item ">
            <li>
                <a href="#">
                    <i class="fas fa-book"></i>
                    <span>SEL Themes</span>
                </a>
            </li>
        </ul>
        <!--Schools button-->
        <ul class="menu-item ">
            <li>
                <a href="/admin/school/school.html">
                    <i class="fas fa-school"></i>
                    <span>Schools</span>
                </a>
            </li>
        </ul>
        <!--Students button-->
        <ul class="menu-item ">
            <li>
                <a href="/admin/student/student.html">
                    <i class="fas fa-user-graduate"></i>
                    <span>Students</span>
                </a>
            </li>
        </ul>
        <!--Reports button-->
        <ul class="menu-item ">
            <li>
                <a href="/admin/report/report.html">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </a>
            </li>
        </ul>
        <!--Assign role button-->
        <ul class="menu-item ">
            <li>
                <a href="/admin/manage user/manageUser.html">
                    <i class="fas fa-user-cog"></i>
                    <span>Assign Role</span>
                </a>
            </li>
        </ul>
        <!--Reports button-->
        <ul class="menu-item ">
            <li>
                <a href="/admin/settings/settings.html">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
        <!--Logout button-->
        <ul class="menu-item ">
            <li>
                <a href="/login/login.html">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log Out</span>
                </a>
            </li>
        </ul>
    </div>
    
    <!--main content space-->
    <div class="main-content">
        <div class="header">
            <div class="nav">
                <span>Admin</span>
                <h2>Dashboard</h2>
                <div class="search">
                    <input type="text" placeholder="Search...">
                    <i class="fa-solid fa-search"></i>
                </div>
                <img src="/images/user.png" alt=""/>
            </div>
        </div>
        <!--Cards-->
        <div class="stats-grid">
            <div class="card">
                <!-- Add user form -->
                <div class="signup-container">
                    <form id="createUserForm">
                        <h2>Add User</h2>
                        <div class="input-group">
                            <i class="icon-user"></i>
                            <input type="text" placeholder="Enter Username" id="username" required>
                        </div>
                        <div class="input-group">
                            <i class="icon-lock"></i>
                            <input type="password" placeholder="Create Password" id="password" required>
                        </div>
                        <div class="input-group">
                            <i class="icon-lock"></i>
                            <input type="password" placeholder="Retype Password" id="retypePassword" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('retypePassword')"></i>
                        </div>
                        <div class="input-group">
                            <i class="icon-phone"></i>
                            <input type="tel" placeholder="Enter Phone Number" id="phone" required>
                        </div>
                        <div class="input-group">
                            <select id="role" required>
                                <option value="" disabled selected>Select role</option>
                                <option value="Admin">Admin</option>
                                <option value="Educator">Educator</option>
                                <option value="Student">Student</option>
                                <option value="Accountant">Accountant</option>
                            </select>
                        </div>
                        <button class="btn_add" type="submit">Add</button>
                    </form>
                </div>
            </div>
            <div class="card">
                <!-- user table -->
                <div class="signup-container">
                    <h2>User Accounts</h2>
                    <table class="table table-hover" id="userTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User accounts will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
   <!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(() => {
      let users = [];

      const renderTable = (tableId, data, columns) => {
          const tbody = $(tableId).find('tbody');
          tbody.empty();
          data.forEach(item => {
              const row = `<tr>${columns.map(col => `<td>${item[col]}</td>`).join('')}<td>${getActions(tableId, item)}</td></tr>`;
              tbody.append(row);
          });
      };

      const getActions = (tableId, item) => {
          return `
              <button class="btn btn-success btn-sm edit-user" data-username="${item.username}">Edit</button>
              <button class="btn btn-danger btn-sm delete-user" data-username="${item.username}">Delete</button>
          `;
      };

      const resetForm = (formId, buttonText) => {
          $(formId)[0].reset();
          $(formId).find('button[type="submit"]').text(buttonText).off('click').on('click', function(event) {
              $(formId).submit();
          });
      };

      $('#createUserForm').submit(event => {
          event.preventDefault();
          const username = $('#username').val();
          const password = $('#password').val();
          const retypePassword = $('#retypePassword').val();
          const phone = $('#phone').val();
          const role = $('#role').val();

          if (password !== retypePassword) {
              Swal.fire('Error', 'Passwords do not match!', 'error');
              return;
          }

          const user = { username, role };
          users.push(user);
          renderTable('#userTable', users, ['username', 'role']);
          Swal.fire('Success', 'User added successfully!', 'success');

          // Send SMS
          $.ajax({
              url: 'http://localhost:5500/send-sms',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ phone, username, password, role }),
              success: (response) => {
                  console.log('SMS API Response:', response);
                  if (response.success) {
                      Swal.fire('Success', 'SMS sent successfully!', 'success');
                  } else {
                      Swal.fire('Error', 'Failed to send SMS', 'error');
                  }
              },
              error: (error) => {
                  console.log('SMS API Error:', error);
                  Swal.fire('Error', 'Failed to send SMS', 'error');
              }
          });

          resetForm('#createUserForm', 'Add');
      });

      $(document).on('click', '.edit-user', function() {
          const username = $(this).data('username');
          const user = users.find(u => u.username === username);
          $('#username').val(user.username).prop('disabled', true);
          $('#role').val(user.role);
          $('button[type="submit"]').text('Update Account').off('click').on('click', function(event) {
              event.preventDefault();
              user.role = $('#role').val();
              renderTable('#userTable', users, ['username', 'role']);
              $('#username').prop('disabled', false).val('');
              $('#role').val('');
              resetForm('#createUserForm', 'Add');
          });
      });

      $(document).on('click', '.delete-user', function() {
          const username = $(this).data('username');
          users = users.filter(u => u.username !== username);
          renderTable('#userTable', users, ['username', 'role']);
      });
  });
</script>
    </body>
</html>